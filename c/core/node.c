#include <Ubject.h>
#include <stdlib.h>

#include "node.r.h"

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Static function declarations
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////

#define STATIC_FUNC_DECL

static void *laud_node_dtor(struct laud_node *self);

#undef STATIC_FUNC_DECL

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Class Initializer
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////

#define CLASS_INIT

const void *LaudNodeClass = NULL;
const void *LaudNode = NULL;

static void __attribute__((constructor(LAUD_NODE_PRIORITY)))
library_initializer(void) {

  if (!LaudNodeClass) {
    LaudNodeClass = LaudBaseClass;
  }

  if (!LaudNode) {
    LaudNode =
        init(LaudNodeClass, LaudBase, sizeof(struct laud_node), className,
             "LaudNode",           // class name
             dtor, laud_node_dtor, // destructor
             // laud_add, base_operator,        // addition
             // laud_matrix_dot, base_operator, // matrix dot
             // laud_to_string, base_operator,  // to string
             // laud_slice, base_operator,      // slice
             /*ctor, laud_var_ctor,*/
             NULL);
  }
}

#undef CLASS_INIT

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Implemention
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////

#define IMPL

static void *laud_node_dtor(struct laud_node *self) {
  size_t i = 0;

  if (self->incoming) {
    while (self->incoming[i]) {
      blip(self->incoming[i++]);
    }
    free(self->incoming);
    self->incoming = NULL;
  }

  i = 0;
  if (self->outgoing) {
    while (self->outgoing[i]) {
      blip(self->outgoing[i++]);
    }
    free(self->outgoing);
    self->outgoing = NULL;
  }

  return super_dtor(LaudNode, self);
}
