#include <Ubject.h>
#include <stdlib.h>

#include "node.r.h"
#include "node.h"

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Static function declarations
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////

#define STATIC_FUNC_DECL

static void *laud_node_dtor(struct laud_node *self);

#undef STATIC_FUNC_DECL

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Class Initializer
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////

#define CLASS_INIT

const void *LaudNodeClass = NULL;
const void *LaudNode = NULL;

static void __attribute__((constructor(LAUD_NODE_PRIORITY)))
library_initializer(void)
{

  if (!LaudNodeClass)
  {
    LaudNodeClass = LaudBaseClass;
  }

  if (!LaudNode)
  {
    LaudNode =
        init(LaudNodeClass, LaudBase, sizeof(struct laud_node), className,
             "LaudNode",           // class name
             dtor, laud_node_dtor, // destructor
             NULL);
  }
}

#undef CLASS_INIT

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Implemention
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////

#define IMPL

static void *laud_node_dtor(struct laud_node *self)
{
  uint64_t i = 0;

  if (self->incoming)
  {
    while (self->incoming[i])
    {
      blip(self->incoming[i++]);
    }
    free(self->incoming);
    self->incoming = NULL;
  }

  i = 0;
  if (self->outgoing)
  {
    while (self->outgoing[i])
    {
      blip(self->outgoing[i++]);
    }
    free(self->outgoing);
    self->outgoing = NULL;
  }

  return super_dtor(LaudNode, self);
}

void laud_replace_independent_node(void *var_node, uint64_t index,
                                   void *independent_node)
{
  struct laud_node *y_node = var_node;
  blip(y_node->incoming[index]);
  y_node->incoming[index] = independent_node;
  reference(independent_node);
  //todo: update incoming and outgoing nodes' list
}
